<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Test LiveKit Publish</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .video-container { margin: 20px 0; }
    video { width: 300px; height: 200px; border: 1px solid #ccc; }
    button { padding: 10px 20px; margin: 10px; cursor: pointer; }
    input { padding: 8px; margin: 5px; width: 400px; }
    .status { padding: 10px; margin: 10px 0; border-radius: 4px; }
    .success { background: #d4edda; color: #155724; }
    .error { background: #f8d7da; color: #721c24; }
  </style>
</head>
<body>
  <h1>LiveKit Test Publisher</h1>
  
  <div>
    <label>LiveKit URL:</label><br>
    <input type="text" id="lkUrl" value="wss://hen-ho-sf416dcq.livekit.cloud" placeholder="LiveKit server URL">
  </div>
  
  <div>
    <label>API Key:</label><br>
    <input type="text" id="apiKey" placeholder="Your LiveKit API Key">
  </div>
  
  <div>
    <label>API Secret:</label><br>
    <input type="text" id="apiSecret" placeholder="Your LiveKit API Secret">
  </div>
  
  <div>
    <label>Room Name:</label><br>
    <input type="text" id="roomName" value="henho-main" placeholder="Room name">
  </div>
  
  <div>
    <label>Identity:</label><br>
    <input type="text" id="identity" value="test-mc" placeholder="Your identity">
  </div>
  
  <div>
    <label>Role:</label><br>
    <select id="role">
      <option value="mc">MC</option>
      <option value="girl">Girl</option>
      <option value="boy">Boy</option>
    </select>
  </div>
  
  <div>
    <button onclick="generateToken()">Generate Token</button>
    <button onclick="connectRoom()">Connect & Publish</button>
    <button onclick="disconnect()">Disconnect</button>
  </div>
  
  <div id="status"></div>
  
  <div class="video-container">
    <h3>Local Video:</h3>
    <video id="localVideo" autoplay muted></video>
  </div>
  
  <div class="video-container">
    <h3>Room Info:</h3>
    <div id="roomInfo"></div>
  </div>

  <script src="https://unpkg.com/livekit-client@2.5.3/dist/livekit-client.umd.js"></script>
  <script>
    let room = null;
    let localVideoTrack = null;
    
    function showStatus(message, isError = false) {
      const status = document.getElementById('status');
      status.textContent = message;
      status.className = 'status ' + (isError ? 'error' : 'success');
      console.log(message);
    }
    
    async function generateToken() {
      try {
        const apiKey = document.getElementById('apiKey').value;
        const apiSecret = document.getElementById('apiSecret').value;
        const roomName = document.getElementById('roomName').value;
        const identity = document.getElementById('identity').value;
        const role = document.getElementById('role').value;
        
        if (!apiKey || !apiSecret) {
          showStatus('Please enter API Key and Secret', true);
          return;
        }
        
        // Simple client-side token generation (not recommended for production)
        // For production, generate token on your server
        const livekit = window.LivekitClient || window.LiveKitClient || window.LiveKit;
        const { AccessToken } = livekit;
        
        const token = new AccessToken(apiKey, apiSecret, {
          identity: identity,
          ttl: '1h',
          metadata: JSON.stringify({ role: role })
        });
        
        token.addGrant({
          room: roomName,
          roomJoin: true,
          canPublish: true,
          canSubscribe: true,
        });
        
        const jwt = await token.toJwt();
        showStatus('Token generated successfully!');
        
        // Store token for connection
        window.testToken = jwt;
        
      } catch (error) {
        showStatus('Error generating token: ' + error.message, true);
      }
    }
    
    async function connectRoom() {
      try {
        if (!window.testToken) {
          showStatus('Please generate token first', true);
          return;
        }
        
        const lkUrl = document.getElementById('lkUrl').value;
        const livekit = window.LivekitClient || window.LiveKitClient || window.LiveKit;
        
        showStatus('Connecting to room...');
        
        // Create room
        room = new livekit.Room();
        
        // Connect to room
        await room.connect(lkUrl, window.testToken);
        showStatus('Connected to room successfully!');
        
        // Get user media
        const stream = await navigator.mediaDevices.getUserMedia({ 
          video: true, 
          audio: true 
        });
        
        // Show local video
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = stream;
        
        // Create LiveKit tracks
        const videoTrack = await livekit.createLocalVideoTrack();
        const audioTrack = await livekit.createLocalAudioTrack();
        
        // Publish tracks
        await room.localParticipant.publishTrack(videoTrack);
        await room.localParticipant.publishTrack(audioTrack);
        
        localVideoTrack = videoTrack;
        
        showStatus('Publishing video and audio successfully!');
        updateRoomInfo();
        
        // Listen for participants
        room.on('participantConnected', (participant) => {
          console.log('Participant connected:', participant.identity);
          updateRoomInfo();
        });
        
        room.on('participantDisconnected', (participant) => {
          console.log('Participant disconnected:', participant.identity);
          updateRoomInfo();
        });
        
      } catch (error) {
        showStatus('Error connecting: ' + error.message, true);
      }
    }
    
    async function disconnect() {
      try {
        if (room) {
          await room.disconnect();
          room = null;
        }
        
        if (localVideoTrack) {
          localVideoTrack.stop();
          localVideoTrack = null;
        }
        
        const localVideo = document.getElementById('localVideo');
        localVideo.srcObject = null;
        
        showStatus('Disconnected successfully');
        updateRoomInfo();
        
      } catch (error) {
        showStatus('Error disconnecting: ' + error.message, true);
      }
    }
    
    function updateRoomInfo() {
      const roomInfo = document.getElementById('roomInfo');
      if (!room) {
        roomInfo.innerHTML = 'Not connected';
        return;
      }
      
      const participants = Array.from(room.remoteParticipants.values());
      const info = `
        <strong>Room:</strong> ${room.name || 'Unknown'}<br>
        <strong>Local Identity:</strong> ${room.localParticipant?.identity}<br>
        <strong>Remote Participants:</strong> ${participants.length}<br>
        <strong>Participants:</strong><br>
        ${participants.map(p => `- ${p.identity} (${p.tracks.size} tracks)`).join('<br>')}
      `;
      
      roomInfo.innerHTML = info;
    }
  </script>
</body>
</html>