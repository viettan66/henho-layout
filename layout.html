<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Custom Layout Livestream</title>
  <style>
    body {
      margin: 0;
      background: black;
      height: 100vh;
      display: grid;
      grid-template-rows: 80% 20%;
      grid-template-columns: 33.3% 33.3% 33.3%;
      grid-template-areas:
        "nguoi2 mc nguoi1"
        "banbe2 . banbe1";
      gap: 2px;
    }

    .video-box {
      position: relative;
      border: 2px solid white;
      width: 100%;
      height: 100%;
      overflow: hidden;
    }

    video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .name-label {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      text-align: center;
      padding: 3px;
      background: rgba(0, 0, 0, 0.5);
      color: white;
      font-size: 14px;
    }

    .mc     { grid-area: mc; }
    .nguoi1 { grid-area: nguoi1; }
    .nguoi2 { grid-area: nguoi2; }
    .banbe1 { grid-area: banbe1; display: flex; flex-wrap: nowrap; }
    .banbe2 { grid-area: banbe2; display: flex; flex-wrap: nowrap; }

    .friend-video {
      flex: 1;
      margin: 1px;
    }
  </style>
</head>
<body>
  <div class="video-box nguoi2" id="nguoi2"></div>
  <div class="video-box mc" id="mc"></div>
  <div class="video-box nguoi1" id="nguoi1"></div>
  <div class="banbe2" id="banbe2"></div>
  <div class="banbe1" id="banbe1"></div>

  <script type="module">
    import { connect } from "https://cdn.livekit.io/js/livekit-client.min.js";

    const urlParams = new URLSearchParams(window.location.search);
    const roomName = urlParams.get("room");
    const token = urlParams.get("token");

    const room = await connect("wss://hen-ho-sf416dcq.livekit.cloud", token);

    const layoutMap = {
      "mc": "mc",
      "nguoi1": "nguoi1",
      "nguoi2": "nguoi2"
    };

    const banbe1List = ["banbe1-1", "banbe1-2", "banbe1-3", "banbe1-4", "banbe1-5"];
    const banbe2List = ["banbe2-1", "banbe2-2", "banbe2-3", "banbe2-4", "banbe2-5"];

    function renderParticipant(participant) {
      participant.tracks.forEach(pub => {
        if (pub.track && pub.track.kind === "video") {
          const videoEl = pub.track.attach();
          videoEl.autoplay = true;
          videoEl.playsInline = true;
          videoEl.muted = true;

          const container = document.createElement("div");
          container.className = "video-box friend-video";
          container.appendChild(videoEl);

          const label = document.createElement("div");
          label.className = "name-label";
          label.innerText = participant.identity;
          container.appendChild(label);

          // Xác định vị trí hiển thị
          if (layoutMap[participant.identity]) {
            const box = document.getElementById(layoutMap[participant.identity]);
            box.appendChild(videoEl);
            box.appendChild(label);
          } else if (banbe1List.includes(participant.identity)) {
            document.getElementById("banbe1").appendChild(container);
          } else if (banbe2List.includes(participant.identity)) {
            document.getElementById("banbe2").appendChild(container);
          }
        }
      });

      participant.on("trackSubscribed", (track, pub) => {
        if (track.kind === "video") {
          renderParticipant(participant);
        }
      });
    }

    room.participants.forEach(renderParticipant);
    room.on("participantConnected", renderParticipant);

    // Render localParticipant nếu là MC (hoặc host cần lên hình)
    renderParticipant(room.localParticipant);
  </script>
</body>
</html>
